<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

  <meta name="description" content="Personal blog about IT, Electronics, InfoSec, Hacking, Bug Hunting...">
  <meta name="keywords" content="Blog, Computer Science, IT, Electronics, Hacking, InfoSec, CTF, Bug Bounty, Open Source">
  <meta name="author" content="Paul-Emmanuel Raoul">

  
  <link rel="apple-touch-icon" sizes="180x180" href="&#x2F;favicon&#x2F;apple-touch-icon.png" />
  
  
  <link rel="icon" type="image/png" sizes="16x16" href="&#x2F;favicon&#x2F;favicon-16x16.png" />
  
  
  <link rel="icon" type="image/png" sizes="32x32" href="&#x2F;favicon&#x2F;favicon-32x32.png" />
  
  
  <link rel="manifest" href="&#x2F;favicon&#x2F;site.webmanifest" />
  

  <title>Skyper&#x27;s blog</title>

  <link rel="stylesheet" href="https://blog.skyplabs.net/css/style.css">

  
  <script defer data-domain="blog.skyplabs.net" src="https://plausible.io/js/plausible.js"></script>
  

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://blog.skyplabs.net/atom.xml">
</head>
<body vocab="http://schema.org/" typeof="Blog">
  
  <div class="sidebar">
    <div class="container sidebar-sticky">
      <div class="sidebar-about">
        <h1><a href="https://blog.skyplabs.net">Skyper&#x27;s blog</a></h1>
        <p class="lead">Personal blog about IT, Electronics, InfoSec, Hacking, Bug Hunting...</p>
      </div>

      <div class="sidebar-links">
        
        <a class="icon-github" href="https://github.com/SkypLabs" title="GitHub" target="_blank" rel="noopener noreferrer"></a>
        

        
        <a class="icon-docker-hub" href="https://hub.docker.com/u/skyplabs" title="Docker Hub" target="_blank" rel="noopener noreferrer"></a>
        

        
        
        
        <a class="icon-mastodon" href="https://fosstodon.org/@Skyper" title="Mastodon" target="_blank" rel="me noopener noreferrer"></a>
        

        
        <a class="icon-twitter" href="https://twitter.com/SkypLabs" title="Twitter" target="_blank" rel="noopener noreferrer"></a>
        

        
        <a class="icon-linkedin" href="https://www.linkedin.com/in/peraoul" title="LinkedIn" target="_blank" rel="noopener noreferrer"></a>
        

        
        <a class="icon-keybase" href="https://keybase.io/skyplabs" title="Keybase" target="_blank" rel="noopener noreferrer"></a>
        

        
        <a class="icon-email" href="mailto:skyper@skyplabs.net" title="Email"></a>
        

        <a class="icon-rss" href="https://blog.skyplabs.net/atom.xml" title="RSS"></a>
      </div>

      <nav class="sidebar-nav">
        <a class="sidebar-nav-item" href="/">Home</a>
        
        
        <a class="sidebar-nav-item" href="/publications/">Publications</a>
        
        <a class="sidebar-nav-item" href="/about/">About me</a>
        
        <a class="sidebar-nav-item" href="/contact/">Contact</a>
        
        <a class="sidebar-nav-item" href="/support/">Support me</a>
        
      </nav>
    </div>
  </div>
  

  <div class="content container">
    
<article class="post" property="blogPost" typeof="BlogPosting">
  
  <div class="post-meta">
    
    <h2 class="post-title" property="headline">[Python] Sniffing inside a thread with Scapy</h2>
    

    <time class="post-date" datetime="2018-03-01 00:00"
      property="datePublished">01 Mar 2018</time>
    <div class="post-author" property="author" typeof="Person" hidden>
      <span property="name">Paul-Emmanuel Raoul</span>
      <span property="givenName">Paul-Emmanuel</span>
      <span property="familyName">Raoul</span>
      <span property="alternateName">Skyper</span>
      <span property="email">skyper@skyplabs.net</span>
    </div>
  </div>


  <div class="post-content" property="articleBody">
    <p>Scapy is an incredible tool when it comes to playing with the network. As it is
written on its <a rel="noopener nofollow noreferrer" target="_blank" href="https://scapy.net/">official website</a>, Scapy can replace a majority
of network tools such as nmap, hping and tcpdump.</p>
<p>One of the features offered by Scapy is to sniff the network packets passing
through a computer's NIC. Below is a small example:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;SkypLabs&#x2F;06bd7f414f51d700e04be705cb32659d.js?file=sniff_main_thread.py"></script>
</div>
<p>This little sniffer displays the source and the destination of all packets
having an IP layer:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ sudo python3 sniff_main_thread.py
</span><span>[*] Start sniffing...
</span><span>[!] New Packet: 10.137.2.30 -&gt; 10.137.2.1
</span><span>[!] New Packet: 10.137.2.30 -&gt; 10.137.2.1
</span><span>[!] New Packet: 10.137.2.1 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.1 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>^C[*] Stop sniffing
</span></code></pre>
<p>It will continue to sniff network packets until it receives a keyboard
interruption (<code>CTRL+C</code>).</p>
<span id="continue-reading"></span>
<p>Now, let's look at a new example:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;SkypLabs&#x2F;06bd7f414f51d700e04be705cb32659d.js?file=sniff_thread_issue.py"></script>
</div>
<p>This piece of code does exactly the same thing as the previous one except that
this time the <code>sniff</code> function is executed inside a dedicated thread. Everything
works well with this new version except when it comes to stopping the sniffer:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ sudo python3 sniff_thread_issue.py
</span><span>[*] Start sniffing...
</span><span>[!] New Packet: 10.137.2.30 -&gt; 10.137.2.1
</span><span>[!] New Packet: 10.137.2.30 -&gt; 10.137.2.1
</span><span>[!] New Packet: 10.137.2.1 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.1 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>[!] New Packet: 216.58.198.68 -&gt; 10.137.2.30
</span><span>[!] New Packet: 10.137.2.30 -&gt; 216.58.198.68
</span><span>^C[*] Stop sniffing
</span><span>^CTraceback (most recent call last):
</span><span>  File &quot;sniff_thread_issue.py&quot;, line 25, in &lt;module&gt;
</span><span>    sleep(100)
</span><span>KeyboardInterrupt
</span><span>
</span><span>During handling of the above exception, another exception occurred:
</span><span>
</span><span>Traceback (most recent call last):
</span><span>  File &quot;sniff_thread_issue.py&quot;, line 28, in &lt;module&gt;
</span><span>    sniffer.join()
</span><span>  File &quot;/usr/lib/python3.5/threading.py&quot;, line 1054, in join
</span><span>    self._wait_for_tstate_lock()
</span><span>  File &quot;/usr/lib/python3.5/threading.py&quot;, line 1070, in _wait_for_tstate_lock
</span><span>    elif lock.acquire(block, timeout):
</span><span>KeyboardInterrupt
</span><span>^CException ignored in: &lt;module &#39;threading&#39; from &#39;/usr/lib/python3.5/threading.py&#39;&gt;
</span><span>Traceback (most recent call last):
</span><span>  File &quot;/usr/lib/python3.5/threading.py&quot;, line 1288, in _shutdown
</span><span>    t.join()
</span><span>  File &quot;/usr/lib/python3.5/threading.py&quot;, line 1054, in join
</span><span>    self._wait_for_tstate_lock()
</span><span>  File &quot;/usr/lib/python3.5/threading.py&quot;, line 1070, in _wait_for_tstate_lock
</span><span>    elif lock.acquire(block, timeout):
</span><span>KeyboardInterrupt
</span></code></pre>
<p>When <code>CTRL+C</code> is pressed, a <code>SIGTERM</code> signal is sent to the process executing
the Python script, triggering its exit routine. However, as said in the
<a rel="noopener nofollow noreferrer" target="_blank" href="https://docs.python.org/3/library/signal.html">official documentation about signals</a>, only the main thread
receives signals:</p>
<blockquote>
<p>Python signal handlers are always executed in the main Python thread, even if
the signal was received in another thread.</p>
</blockquote>
<p>As a result, when <code>CTRL+C</code> is pressed, only the main thread raises a
<code>KeyboardInterrupt</code> exception. The sniffing thread will continue its infinite
sniffing loop, blocking at the same time the call of <code>sniffer.join()</code>.</p>
<p>So, how can the sniffing thread be stopped if not by signals? Let's have a look
at this next example:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;SkypLabs&#x2F;06bd7f414f51d700e04be705cb32659d.js?file=sniff_thread_issue_2.py"></script>
</div>
<p>As you may have noticed, we are now using the <code>stop_filter</code> parameter in the
<code>sniff</code> function call. This parameter expects to receive a function which will
be called after each new packet to evaluate if the sniffer should continue its
job or not. An <code>Event</code> object named <code>stop_sniffer</code> is used for that purpose. It
is set to <code>true</code> when the <code>join</code> method is called to stop the thread.</p>
<p>Is this the end of the story? Not really...</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ sudo python3 sniff_thread_issue_2.py
</span><span>[*] Start sniffing...
</span><span>^C[*] Stop sniffing
</span><span>[!] New Packet: 10.137.2.30 -&gt; 10.137.2.1
</span></code></pre>
<p>One side effect remains. Because the <code>should_stop_sniffer</code> method is called only
once after each new packet, if it returns <code>false</code>, the sniffer will continue its
job, going back to its infinite sniffing loop. This is why the sniffer stopped
one packet ahead of the keyboard interruption.</p>
<p>A solution would be to force the sniffing thread to stop. As explained in the
<a rel="noopener nofollow noreferrer" target="_blank" href="https://docs.python.org/3/library/threading.html">official documentation about threading</a>, it is possible to
flag a thread as a daemon thread for that purpose:</p>
<blockquote>
<p>A thread can be flagged as a “daemon thread”. The significance of this flag is
that the entire Python program exits when only daemon threads are left. The
initial value is inherited from the creating thread. The flag can be set
through the daemon property or the daemon constructor argument.</p>
</blockquote>
<p>However, even if this solution would work, the thread won't release the
resources it might hold:</p>
<blockquote>
<p>Daemon threads are abruptly stopped at shutdown. Their resources (such as open
files, database transactions, etc.) may not be released properly. If you want
your threads to stop gracefully, make them non-daemonic and use a suitable
signalling mechanism such as an Event.</p>
</blockquote>
<p>The <code>sniff</code> function uses a socket which is released just before exiting, after
the sniffing loop:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">try</span><span>:
</span><span>    </span><span style="color:#b48ead;">while </span><span>sniff_sockets:
</span><span>        // Sniffing loop
</span><span style="color:#b48ead;">except </span><span>KeyboardInterrupt:
</span><span>    </span><span style="color:#b48ead;">pass
</span><span style="color:#b48ead;">if </span><span>opened_socket is </span><span style="color:#d08770;">None</span><span>:
</span><span>    </span><span style="color:#b48ead;">for </span><span>s </span><span style="color:#b48ead;">in </span><span>sniff_sockets:
</span><span>        s.</span><span style="color:#bf616a;">close</span><span>()
</span><span style="color:#b48ead;">return </span><span>plist.</span><span style="color:#bf616a;">PacketList</span><span>(lst,&quot;</span><span style="color:#a3be8c;">Sniffed</span><span>&quot;)
</span></code></pre>
<p>Therefore, the solution I suggest is to open the socket outside the <code>sniff</code>
function and to give it to this last one as parameter. Consequently, it would be
possible to force-stop the sniffing thread while closing its socket properly:</p>
<div >
    <script src="https:&#x2F;&#x2F;gist.github.com&#x2F;SkypLabs&#x2F;06bd7f414f51d700e04be705cb32659d.js?file=sniff_thread_solution.py"></script>
</div>
<p>Et voilà! The sniffing thread now waits for 2 seconds after having received a
keyboard interrupt, letting the time to the <code>sniff</code> function to terminate its
job by itself, after which the sniffing thread will be force-stopped and its
socket properly closed from the main thread.</p>

  </div>

  
  
  <span class="categories" property="keywords">
    
    
    <a href="https:&#x2F;&#x2F;blog.skyplabs.net&#x2F;categories&#x2F;programming&#x2F;">Programming</a>
    
    
  </span>
  

  
  <span class="tags" property="keywords">
    
    
    <a href="https:&#x2F;&#x2F;blog.skyplabs.net&#x2F;tags&#x2F;python&#x2F;">Python</a>
     · 
    
    
    <a href="https:&#x2F;&#x2F;blog.skyplabs.net&#x2F;tags&#x2F;scapy&#x2F;">Scapy</a>
    
    
  </span>
  

</article>

  </div>
  <script type="text/javascript" src="https://blog.skyplabs.net/elasticlunr.min.js"></script>
  <script type="text/javascript" src="https://blog.skyplabs.net/search_index.en.js"></script>
  <script type="text/javascript" src="https://blog.skyplabs.net/js/search.js"></script>
</body>
</html>
